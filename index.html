<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Chi Ti√™u</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .summary-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .amount {
            font-size: 2em;
            font-weight: bold;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr auto;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .transactions-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
        }

        .transactions-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
        }

        tbody tr {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f0f0f0;
        }

        .category-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
        }

        .food { background: #ff6b6b; }
        .study { background: #4ecdc4; }
        .entertainment { background: #ffd93d; color: #333; }
        .transportation { background: #6c5ce7; }
        .others { background: #95a5a6; }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .clear-all-btn {
            background: #e74c3c;
            margin-top: 15px;
        }

        .clear-all-btn:hover {
            background: #c0392b;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ Dashboard Chi Ti√™u</h1>

        <div class="summary">
            <div class="summary-card">
                <h3>T·ªïng Chi Ti√™u</h3>
                <div class="amount" id="totalExpense">0 ngh√¨n VNƒê</div>
            </div>
            <div class="summary-card">
                <h3>S·ªë Giao D·ªãch</h3>
                <div class="amount" id="totalTransactions">0</div>
            </div>
            <div class="summary-card">
                <h3>Chi Nhi·ªÅu Nh·∫•t</h3>
                <div class="amount" id="topCategory">-</div>
            </div>
        </div>

        <div class="form-section">
            <h2>‚úçÔ∏è Th√™m Chi Ti√™u M·ªõi</h2>
            <form id="expenseForm">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr 2fr auto;">
                    <div class="form-group">
                        <label for="amount">S·ªë Ti·ªÅn (VNƒê)</label>
                        <input type="number" id="amount" placeholder="50000" required min="1">
                    </div>
                    <div class="form-group">
                        <label for="category">Danh M·ª•c</label>
                        <select id="category" required>
                            <option value="food">üçî ƒÇn u·ªëng</option>
                            <option value="study">üìö H·ªçc t·∫≠p</option>
                            <option value="entertainment">üéÆ Gi·∫£i tr√≠</option>
                            <option value="transportation">üöó Di chuy·ªÉn</option>
                            <option value="others">üì¶ Kho·∫£n kh√°c</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ng√†y / Th√°ng / NƒÉm</label>
                        <div style="display: flex; gap: 6px;">
                            <input type="number" id="inputDay" placeholder="DD" min="1" max="31" required style="width: 60px; text-align: center;">
                            <input type="number" id="inputMonth" placeholder="MM" min="1" max="12" required style="width: 60px; text-align: center;">
                            <input type="number" id="inputYear" placeholder="YYYY" min="2000" max="2100" required style="width: 80px; text-align: center;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">M√¥ T·∫£</label>
                        <input type="text" id="description" placeholder="Mua c√† ph√™..." required>
                    </div>
                    <button type="submit">Th√™m</button>
                </div>
            </form>
        </div>

        <div class="form-section">
            <h2>üîç L·ªçc Theo Th·ªùi Gian</h2>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto auto;">
                <div class="form-group">
                    <label for="filterDay">Ng√†y</label>
                    <select id="filterDay">
                        <option value="">T·∫•t c·∫£</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterMonth">Th√°ng</label>
                    <select id="filterMonth">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="0">Th√°ng 1</option>
                        <option value="1">Th√°ng 2</option>
                        <option value="2">Th√°ng 3</option>
                        <option value="3">Th√°ng 4</option>
                        <option value="4">Th√°ng 5</option>
                        <option value="5">Th√°ng 6</option>
                        <option value="6">Th√°ng 7</option>
                        <option value="7">Th√°ng 8</option>
                        <option value="8">Th√°ng 9</option>
                        <option value="9">Th√°ng 10</option>
                        <option value="10">Th√°ng 11</option>
                        <option value="11">Th√°ng 12</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterYear">NƒÉm</label>
                    <select id="filterYear">
                        <option value="">T·∫•t c·∫£</option>
                    </select>
                </div>
                <button type="button" id="applyFilterBtn">√Åp D·ª•ng</button>
                <button type="button" id="resetFilterBtn" style="background: #95a5a6;">Reset</button>
            </div>
            <div id="filterInfo" style="margin-top: 15px; color: #667eea; font-weight: bold; text-align: center;"></div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <h3>üìä Bi·ªÉu ƒê·ªì Tr√≤n - T·ªâ L·ªá Chi Ti√™u</h3>
                <canvas id="pieChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>üìà Bi·ªÉu ƒê·ªì C·ªôt - Chi Ti√™u Theo Danh M·ª•c</h3>
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <div class="transactions-section">
            <h2>üìã L·ªãch S·ª≠ Giao D·ªãch</h2>
            <table>
                <thead>
                    <tr>
                        <th>Ng√†y</th>
                        <th>Danh M·ª•c</th>
                        <th>M√¥ T·∫£</th>
                        <th>S·ªë Ti·ªÅn</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody id="transactionsTable">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #999;">Ch∆∞a c√≥ giao d·ªãch n√†o</td>
                    </tr>
                </tbody>
            </table>
            <button class="clear-all-btn" id="clearAllBtn">X√≥a T·∫•t C·∫£</button>
        </div>
    </div>

    <script>
        // Kh·ªüi t·∫°o d·ªØ li·ªáu
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        
        // Tr·∫°ng th√°i b·ªô l·ªçc
        let currentFilter = {
            day: '',
            month: '',
            year: ''
        };
        
        // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu, th√™m d·ªØ li·ªáu m·∫´u
        if (expenses.length === 0) {
            expenses = [
                {
                    amount: 45000,
                    category: 'food',
                    description: 'ƒÇn s√°ng b√°nh m√¨',
                    date: new Date(2024, 1, 10, 8, 30).toISOString()
                },
                {
                    amount: 150000,
                    category: 'food',
                    description: 'ƒÇn tr∆∞a v·ªõi b·∫°n',
                    date: new Date(2024, 1, 10, 12, 0).toISOString()
                },
                {
                    amount: 500000,
                    category: 'study',
                    description: 'Mua s√°ch l·∫≠p tr√¨nh',
                    date: new Date(2024, 1, 9, 14, 30).toISOString()
                },
                {
                    amount: 200000,
                    category: 'entertainment',
                    description: 'Xem phim r·∫°p',
                    date: new Date(2024, 1, 9, 19, 0).toISOString()
                },
                {
                    amount: 30000,
                    category: 'transportation',
                    description: 'Grab ƒëi l√†m',
                    date: new Date(2024, 1, 11, 7, 30).toISOString()
                },
                {
                    amount: 50000,
                    category: 'transportation',
                    description: 'Grab v·ªÅ nh√†',
                    date: new Date(2024, 1, 11, 18, 0).toISOString()
                },
                {
                    amount: 100000,
                    category: 'others',
                    description: 'Mua qu√† sinh nh·∫≠t',
                    date: new Date(2024, 1, 8, 16, 0).toISOString()
                },
                {
                    amount: 250000,
                    category: 'food',
                    description: 'ƒêi ƒÉn buffet',
                    date: new Date(2024, 1, 12, 19, 30).toISOString()
                },
                {
                    amount: 300000,
                    category: 'study',
                    description: 'Kh√≥a h·ªçc online',
                    date: new Date(2024, 1, 7, 10, 0).toISOString()
                },
                {
                    amount: 120000,
                    category: 'entertainment',
                    description: 'Mua game Steam',
                    date: new Date(2024, 1, 13, 21, 0).toISOString()
                }
            ];
            localStorage.setItem('expenses', JSON.stringify(expenses));
        }

        const categoryNames = {
            food: 'ƒÇn u·ªëng',
            study: 'H·ªçc t·∫≠p',
            entertainment: 'Gi·∫£i tr√≠',
            transportation: 'Di chuy·ªÉn',
            others: 'Kho·∫£n kh√°c'
        };

        const categoryColors = {
            food: '#ff6b6b',
            study: '#4ecdc4',
            entertainment: '#ffd93d',
            transportation: '#6c5ce7',
            others: '#95a5a6'
        };

        // L·∫•y danh s√°ch chi ti√™u ƒë√£ l·ªçc
        function getFilteredExpenses() {
            if (!currentFilter.day && !currentFilter.month && !currentFilter.year) {
                return expenses;
            }

            return expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                
                if (currentFilter.year && expenseDate.getFullYear() !== parseInt(currentFilter.year)) {
                    return false;
                }
                
                if (currentFilter.month !== '' && expenseDate.getMonth() !== parseInt(currentFilter.month)) {
                    return false;
                }
                
                if (currentFilter.day && expenseDate.getDate() !== parseInt(currentFilter.day)) {
                    return false;
                }
                
                return true;
            });
        }

        // C·∫≠p nh·∫≠t options c·ªßa ng√†y v√† nƒÉm d·ª±a tr√™n d·ªØ li·ªáu
        function updateFilterOptions() {
            const years = [...new Set(expenses.map(exp => new Date(exp.date).getFullYear()))].sort((a, b) => b - a);
            const yearSelect = document.getElementById('filterYear');
            yearSelect.innerHTML = '<option value="">T·∫•t c·∫£</option>' + 
                years.map(year => `<option value="${year}">${year}</option>`).join('');

            // C·∫≠p nh·∫≠t ng√†y (1-31)
            const daySelect = document.getElementById('filterDay');
            daySelect.innerHTML = '<option value="">T·∫•t c·∫£</option>' + 
                Array.from({length: 31}, (_, i) => i + 1).map(day => 
                    `<option value="${day}">${day}</option>`
                ).join('');
        }

        // Hi·ªÉn th·ªã th√¥ng tin b·ªô l·ªçc
        function updateFilterInfo() {
            const filterInfo = document.getElementById('filterInfo');
            const filtered = getFilteredExpenses();
            
            if (!currentFilter.day && !currentFilter.month && !currentFilter.year) {
                filterInfo.textContent = '';
                return;
            }

            let filterText = 'üîé ƒêang xem: ';
            if (currentFilter.day) filterText += `Ng√†y ${currentFilter.day}, `;
            if (currentFilter.month !== '') filterText += `Th√°ng ${parseInt(currentFilter.month) + 1}, `;
            if (currentFilter.year) filterText += `NƒÉm ${currentFilter.year}`;
            
            filterText += ` - T√¨m th·∫•y ${filtered.length} giao d·ªãch`;
            filterInfo.textContent = filterText;
        }

        // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì
        let pieChart, barChart;

        function initCharts() {
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            const barCtx = document.getElementById('barChart').getContext('2d');

            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: []
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.parsed || 0;
                                    let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    let percentage = ((value / total) * 100).toFixed(1);
                                    return label + ': ' + (value / 1000).toLocaleString('vi-VN') + ' ngh√¨n VNƒê (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Chi ti√™u (tri·ªáu VNƒê)',
                        data: [],
                        backgroundColor: []
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return (context.parsed.y / 1000000).toLocaleString('vi-VN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' tri·ªáu VNƒê';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10000000,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toLocaleString('vi-VN') + ' tri·ªáu';
                                }
                            }
                        }
                    }
                }
            });
        }

        // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
        function updateCharts() {
            const filteredExpenses = getFilteredExpenses();
            const categoryTotals = {};
            
            filteredExpenses.forEach(expense => {
                if (!categoryTotals[expense.category]) {
                    categoryTotals[expense.category] = 0;
                }
                categoryTotals[expense.category] += expense.amount;
            });

            const labels = Object.keys(categoryTotals).map(key => categoryNames[key]);
            const data = Object.values(categoryTotals);
            const colors = Object.keys(categoryTotals).map(key => categoryColors[key]);

            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì tr√≤n
            pieChart.data.labels = labels;
            pieChart.data.datasets[0].data = data;
            pieChart.data.datasets[0].backgroundColor = colors;
            pieChart.update();

            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì c·ªôt
            barChart.data.labels = labels;
            barChart.data.datasets[0].data = data;
            barChart.data.datasets[0].backgroundColor = colors;
            barChart.update();
        }

        // C·∫≠p nh·∫≠t t·ªïng quan
        function updateSummary() {
            const filteredExpenses = getFilteredExpenses();
            const total = filteredExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('totalExpense').textContent = (total / 1000).toLocaleString('vi-VN') + ' ngh√¨n VNƒê';
            document.getElementById('totalTransactions').textContent = filteredExpenses.length;

            // T√¨m danh m·ª•c chi nhi·ªÅu nh·∫•t
            const categoryTotals = {};
            filteredExpenses.forEach(exp => {
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
            });

            const topCat = Object.keys(categoryTotals).reduce((a, b) => 
                categoryTotals[a] > categoryTotals[b] ? a : b, '');
            
            document.getElementById('topCategory').textContent = 
                topCat ? categoryNames[topCat] : '-';
        }

        // C·∫≠p nh·∫≠t b·∫£ng giao d·ªãch
        function updateTransactionsTable() {
            const tbody = document.getElementById('transactionsTable');
            const filteredExpenses = getFilteredExpenses();
            console.log('C·∫≠p nh·∫≠t b·∫£ng - S·ªë giao d·ªãch:', filteredExpenses.length);
            
            if (filteredExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Kh√¥ng c√≥ giao d·ªãch n√†o</td></tr>';
                return;
            }

            // T·∫°o map t·ª´ filtered expenses v·ªÅ index g·ªëc trong expenses array
            const expenseMap = new Map();
            expenses.forEach((exp, idx) => expenseMap.set(exp, idx));

            tbody.innerHTML = filteredExpenses.map((expense) => {
                const originalIndex = expenseMap.get(expense);
                return `
                <tr>
                    <td>${new Date(expense.date).toLocaleDateString('vi-VN')}</td>
                    <td><span class="category-badge ${expense.category}">${categoryNames[expense.category]}</span></td>
                    <td>${expense.description}</td>
                    <td><strong>${expense.amount.toLocaleString('vi-VN')} VNƒê</strong></td>
                    <td><button class="delete-btn" onclick="deleteExpense(${originalIndex})">X√≥a</button></td>
                </tr>`;
            }).reverse().join('');
            console.log('ƒê√£ render', filteredExpenses.length, 'd√≤ng v√†o b·∫£ng');
        }

        // Th√™m chi ti√™u
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const amount = parseInt(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const day = parseInt(document.getElementById('inputDay').value);
            const month = parseInt(document.getElementById('inputMonth').value);
            const year = parseInt(document.getElementById('inputYear').value);

            // Ki·ªÉm tra ng√†y h·ª£p l·ªá
            const dateObj = new Date(year, month - 1, day);
            if (
                dateObj.getFullYear() !== year ||
                dateObj.getMonth() !== month - 1 ||
                dateObj.getDate() !== day
            ) {
                alert(`Ng√†y ${day}/${month}/${year} kh√¥ng h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i.`);
                return;
            }

            const expense = {
                amount,
                category,
                description,
                date: dateObj.toISOString()
            };

            expenses.push(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));

            // Reset c√°c tr∆∞·ªùng tr·ª´ ng√†y th√°ng nƒÉm
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            document.getElementById('category').value = 'food';

            updateAll();
        });

        // Set ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
        const now = new Date();
        document.getElementById('inputDay').value = now.getDate();
        document.getElementById('inputMonth').value = now.getMonth() + 1;
        document.getElementById('inputYear').value = now.getFullYear();

        // X√≥a chi ti√™u
        function deleteExpense(index) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?')) {
                expenses.splice(index, 1);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                updateAll();
            }
        }

        // X√≥a t·∫•t c·∫£
        document.getElementById('clearAllBtn').addEventListener('click', function() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ giao d·ªãch?')) {
                expenses = [];
                localStorage.setItem('expenses', JSON.stringify(expenses));
                updateAll();
            }
        });

        // √Åp d·ª•ng b·ªô l·ªçc
        document.getElementById('applyFilterBtn').addEventListener('click', function() {
            currentFilter.day = document.getElementById('filterDay').value;
            currentFilter.month = document.getElementById('filterMonth').value;
            currentFilter.year = document.getElementById('filterYear').value;
            updateAll();
        });

        // Reset b·ªô l·ªçc
        document.getElementById('resetFilterBtn').addEventListener('click', function() {
            document.getElementById('filterDay').value = '';
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            currentFilter = { day: '', month: '', year: '' };
            updateAll();
        });

        // C·∫≠p nh·∫≠t t·∫•t c·∫£
        function updateAll() {
            console.log('updateAll ƒë∆∞·ª£c g·ªçi - S·ªë giao d·ªãch:', expenses.length);
            updateFilterOptions();
            updateFilterInfo();
            updateSummary();
            updateCharts();
            updateTransactionsTable();
            console.log('Ho√†n th√†nh c·∫≠p nh·∫≠t t·∫•t c·∫£');
        }

        // Kh·ªüi t·∫°o
        initCharts();
        updateAll();
    </script>
</body>
</html>